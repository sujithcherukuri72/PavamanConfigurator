<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PavamanDroneConfigurator.UI.ViewModels"
             xmlns:models="using:PavamanDroneConfigurator.Core.Models"
             xmlns:controls="using:PavamanDroneConfigurator.UI.Controls"
             x:Class="PavamanDroneConfigurator.UI.Views.LogAnalyzerPage"
             x:DataType="vm:LogAnalyzerPageViewModel">

    <UserControl.Styles>
        <Style Selector="TextBlock.SectionTitle">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#333"/>
        </Style>
        
        <Style Selector="Button.ToolbarButton">
            <Setter Property="Background" Value="#F0F0F0"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#CCC"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>
        
        <Style Selector="Button.ToolbarButton:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#E0E0E0"/>
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*" Background="#2D2D30">
        
        <!-- TOOLBAR -->
        <Border Grid.Row="0" Background="#3E3E42" Padding="4" BorderBrush="#555" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Spacing="4">
                <Button Classes="ToolbarButton" Content="Graph Left" Command="{Binding GraphLeftCommand}"/>
                <Button Classes="ToolbarButton" Content="Graph Right" Command="{Binding GraphRightCommand}"/>
                <Button Classes="ToolbarButton" Content="Clear Graph" Command="{Binding ClearGraphCommand}"/>
                <Button Classes="ToolbarButton" Content="Load A Log" Command="{Binding BrowseLocalFileCommand}"/>
                <Separator Width="1" Background="#555" Margin="8,2"/>
                <CheckBox Content="Map" IsChecked="{Binding ShowMap}" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                <CheckBox Content="Time" IsChecked="{Binding ShowTime}" Foreground="White" FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0"/>
                <CheckBox Content="Data Table" IsChecked="{Binding ShowDataTable}" Foreground="White" FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0"/>
                <CheckBox Content="Show Params" IsChecked="{Binding ShowParams}" Foreground="White" FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0"/>
                <Separator Width="1" Background="#555" Margin="8,2"/>
                <TextBlock Text="a/None" Foreground="#999" FontSize="11" VerticalAlignment="Center"/>
                <Separator Width="1" Background="#555" Margin="8,2"/>
                <CheckBox Content="Mode" IsChecked="{Binding ShowMode}" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                <CheckBox Content="Errors" IsChecked="{Binding ShowErrors}" Foreground="White" FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0"/>
                <CheckBox Content="MSG" IsChecked="{Binding ShowMsg}" Foreground="White" FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0"/>
                <CheckBox Content="Events" IsChecked="{Binding ShowEvents}" Foreground="White" FontSize="11" VerticalAlignment="Center" Margin="8,0,0,0"/>
            </StackPanel>
        </Border>

        <!-- MAIN CONTENT -->
        <Grid Grid.Row="1" ColumnDefinitions="*,200">
            
            <!-- LEFT: Graph Area -->
            <Grid Grid.Column="0" RowDefinitions="Auto,*,Auto" Background="#1E1E1E">
                
                <!-- Graph Title and Legend -->
                <Border Grid.Row="0" Background="#252526" Padding="8" BorderBrush="#3E3E42" BorderThickness="0,0,0,1">
                    <StackPanel>
                        <TextBlock Text="Value Graph" Foreground="White" FontSize="14" FontWeight="Bold" HorizontalAlignment="Center"/>
                        
                        <!-- Legend with statistics (Mission Planner style) -->
                        <ItemsControl ItemsSource="{Binding SelectedGraphFields}" Margin="0,8,0,0">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:LogFieldInfo">
                                    <Border Background="#333" Padding="6,3" Margin="2" CornerRadius="2">
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <Rectangle Width="12" Height="3" Fill="{Binding Color}" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding DisplayName}" Foreground="{Binding Color}" FontSize="10"/>
                                            <TextBlock Foreground="#888" FontSize="9" VerticalAlignment="Center">
                                                <Run Text="(Min:"/>
                                                <Run Text="{Binding MinValue, StringFormat=F2}"/>
                                                <Run Text=" Max:"/>
                                                <Run Text="{Binding MaxValue, StringFormat=F2}"/>
                                                <Run Text=" Mean:"/>
                                                <Run Text="{Binding MeanValue, StringFormat=F2}"/>
                                                <Run Text=")"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
                
                <!-- Graph Control -->
                <Border Grid.Row="1" Background="#1E1E1E" Margin="4">
                    <Grid>
                        <!-- Real Graph -->
                        <controls:LogGraphControl x:Name="GraphControl" IsVisible="{Binding HasGraphData}"/>
                        
                        <!-- No Data Placeholder -->
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" IsVisible="{Binding !HasGraphData}">
                            <TextBlock Text="Select data series from the right panel" Foreground="#666" FontSize="14"/>
                            <TextBlock Text="to display on the graph" Foreground="#555" FontSize="12" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                        </StackPanel>
                    </Grid>
                </Border>
                
                <!-- X-Axis Label -->
                <TextBlock Grid.Row="2" Text="Time (sec)" Foreground="#999" FontSize="11" HorizontalAlignment="Center" Margin="0,0,0,8"/>
            </Grid>
            
            <!-- RIGHT: TreeView Field Selector (Mission Planner style) -->
            <Border Grid.Column="1" Background="#252526" BorderBrush="#3E3E42" BorderThickness="1,0,0,0">
                <Grid RowDefinitions="Auto,*">
                    
                    <!-- Search Box -->
                    <TextBox Grid.Row="0" Text="{Binding GraphFieldFilter}" Watermark="Search..." 
                             Background="#333" Foreground="White" BorderThickness="0" Margin="4" FontSize="11"/>
                    
                    <!-- TreeView with Message Types and Fields -->
                    <TreeView Grid.Row="1" ItemsSource="{Binding MessageTypesTree}" Background="Transparent">
                        <TreeView.Styles>
                            <Style Selector="TreeViewItem">
                                <Setter Property="IsExpanded" Value="False"/>
                            </Style>
                        </TreeView.Styles>
                        <TreeView.ItemTemplate>
                            <TreeDataTemplate x:DataType="models:LogMessageTypeNode" ItemsSource="{Binding Fields}">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="+" Foreground="#999" FontSize="10" VerticalAlignment="Center" 
                                               IsVisible="{Binding HasChildren}"/>
                                    <TextBlock Text="{Binding Name}" Foreground="White" FontSize="11"/>
                                </StackPanel>
                            </TreeDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                    
                    <!-- Fallback: Simple Field List when TreeView not populated -->
                    <ScrollViewer Grid.Row="1" IsVisible="{Binding !HasTreeData}">
                        <ItemsControl ItemsSource="{Binding FilteredFields}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:LogFieldInfo">
                                    <Border Padding="4,2" Background="Transparent" Cursor="Hand"
                                            PointerPressed="FieldItem_PointerPressed">
                                        <Border.Styles>
                                            <Style Selector="Border:pointerover">
                                                <Setter Property="Background" Value="#333"/>
                                            </Style>
                                        </Border.Styles>
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <CheckBox IsChecked="{Binding IsSelected}" IsHitTestVisible="False"/>
                                            <Rectangle Width="10" Height="10" Fill="{Binding Color}" 
                                                       IsVisible="{Binding IsSelected}" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding DisplayName}" Foreground="White" FontSize="10"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- DOWNLOAD DIALOG OVERLAY -->
        <Border Grid.RowSpan="2" Background="#CC000000" IsVisible="{Binding IsDownloadDialogOpen}">
            <Border Background="#2D2D30" CornerRadius="8" MaxWidth="800" MaxHeight="500" Padding="16"
                    HorizontalAlignment="Center" VerticalAlignment="Center" BorderBrush="#555" BorderThickness="1">
                <Grid RowDefinitions="Auto,*,Auto">
                    <TextBlock Grid.Row="0" Text="Log Files on Flight Controller" Foreground="White" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"/>
                    
                    <DataGrid Grid.Row="1" ItemsSource="{Binding LogFiles}" AutoGenerateColumns="False"
                              IsReadOnly="True" Background="#1E1E1E" Foreground="White" GridLinesVisibility="Horizontal">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected}" Width="40"/>
                            <DataGridTextColumn Header="ID" Binding="{Binding LogId}" Width="50"/>
                            <DataGridTextColumn Header="File Name" Binding="{Binding FileName}" Width="*"/>
                            <DataGridTextColumn Header="Size" Binding="{Binding FileSizeDisplay}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8" Margin="0,12,0,0">
                        <Button Classes="ToolbarButton" Content="Cancel" Width="100" Command="{Binding CloseDownloadDialogCommand}"/>
                        <Button Classes="ToolbarButton" Content="Refresh" Width="100" Command="{Binding RefreshLogsCommand}"/>
                        <Button Classes="ToolbarButton" Content="Download" Width="100" Command="{Binding DownloadSelectedCommand}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>
        
        <!-- DOWNLOAD PROGRESS OVERLAY -->
        <Border Grid.RowSpan="2" Background="#CC000000" IsVisible="{Binding IsDownloading}">
            <Border Background="#2D2D30" CornerRadius="8" MaxWidth="400" Padding="24"
                    HorizontalAlignment="Center" VerticalAlignment="Center" BorderBrush="#555" BorderThickness="1">
                <StackPanel Spacing="12">
                    <TextBlock Text="Downloading..." Foreground="White" FontSize="14" HorizontalAlignment="Center"/>
                    <ProgressBar Value="{Binding DownloadProgress}" Maximum="100" Height="6"/>
                    <TextBlock Text="{Binding DownloadProgressText}" Foreground="#999" FontSize="11" HorizontalAlignment="Center"/>
                    <Button Classes="ToolbarButton" Content="Cancel" Command="{Binding CancelDownloadCommand}" HorizontalAlignment="Center" Width="100"/>
                </StackPanel>
            </Border>
        </Border>
        
        <!-- BUSY OVERLAY -->
        <Border Grid.RowSpan="2" Background="#80000000" IsVisible="{Binding IsBusy}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="{Binding StatusMessage}" Foreground="White" HorizontalAlignment="Center" Margin="0,8,0,0" FontSize="12"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
